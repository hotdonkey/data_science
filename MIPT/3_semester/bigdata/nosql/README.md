# PUBG Kill Statistics Analytics System

Изначально был выбран HBase, но в процессе была реализована логика ветвления записи как в Cassandra так и HBase.

Переключение логики записи (и возможность писать в обе базы) активируется через раскоментирование интересующих секций в
config.yaml.

Так же пункт задания о записи в S3 бакет эволюционировал в fallback функционал и возможность и записи и чтения из бакета,
что позволяет имитировать поведения backup аплоада. 

При формировании выгрузки не была применена фильтрация на события, т.е. в выборку попадают элементы которые не являются 
оружием, но стали таковыми в процессе добивания. Мне показалось, что это может быть интересным usecase в контексте реальной
аналитики и например выявления абъюзов механик со стороны игроков или выявления meme-паттерна, что в свою очередь можно использовать
в cmm-продвижении.


Система состоит из двух компонентов:
- **`writer`** - обрабатывает исходные данные и записывает результат в выбранные хранилища.
- **`client`** - читает агрегированные данные и выводит распределение убийств по оружию за указанный временной диапазон.

## Конфигурация

Все параметры подключения задаются в файле `config.yaml`:

```yaml
minio:
  endpoint_url: "http://localhost:9000"
  access_key: "yeQmq1b1XV3WKYQWMl16"
  secret_key: "tQMgH8B5kSGrD6ccyw2ZCjONBaxpYyWqJNI7piqw"

hbase:
  host: "78.24.180.92"
  port: 9090
  table: "kill_stats_v1"

# cassandra:
#   contact_points: ["master.hadoop.akhcheck.ru"] 
#   port: 9042
#   keyspace: "pubg"
#   table: "kill_stats_v2"
```

> **MinIO обязателен** для работы `--s3-path`.  
> **HBase и Cassandra** активируются только при наличии секции в конфиге.
> **Cassandra** существенно уступает в скорости записи, но возможно это обусловлено первоначальной фиксацией на построении
time_map под структуру HBase.

---

## Запуск

### 1. Запись данных

```bash
./writer.sh [--s3-path s3://bucket/path.json]
```

Пример:
```bash
./writer.sh --s3-path s3://puskstudent2025-17/pubg.json
```

### 2. Чтение данных

```bash
./client.sh <from_sec> <to_sec> [--s3-path s3://bucket/path.json]
```

Пример:
```bash
./client.sh 100 500 --s3-path s3://puskstudent2025-17/pubg.json
```

> Если Cassandra или HBase недоступны — автоматически используется MinIO.

---

## Модель данных

### HBase
- **Row key**: 8-значная секунда (например, `00001234`)
- **Семейство колонок**: `wp`
- **Колонки**: `wp:ak47`, `wp:m416`, ...
- **Значение**: количество убийств

### Cassandra
- **Таблица**: `kill_stats_v2`
- **Схема**:
  ```sql
  PRIMARY KEY (bucket, time_sec, weapon)
  ```
  где `bucket = time_sec // 1000` - для эффективных диапазонных запросов

### MinIO
- Иерархический JSON:
  ```json
  {
    "00001234": { "M416": 5, "AKM": 2 },
    "00001235": { "Grenade": 1 }
  }
  ```

---

## Примечания

- Система устойчива к сбоям: если основное хранилище (HBase/Cassandra) недоступно - используется MinIO.
- Cassandra использует bucketing по 1000 секунд для эффективного чтения без `ALLOW FILTERING`.
- Все credentials вынесены в `config.yaml` - не хранятся в коде.
- Скрипты `writer.sh` и `client.sh` - исполняемые обертки, как того требует задание.